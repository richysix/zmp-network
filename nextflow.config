report.overwrite = true
timelime.overwrite = true
dag.overwrite = true

params.testing = false
params.clustering = false
params.debug = false
params.base_dir = "$SCRATCH/detct/grcz11"
params.script_dir = "$HOME/checkouts/zmp-network/bin"
params.ref_dir = "reference"
params.species='danio_rerio'
params.ensembl_version = "99"
params.ensembl_versionGO = "109"
params.knn_test_params = "80/300/20"
params.cor_measure = "--spearman" // -c
params.labels = "-l 1" // -l
params.skip_rows = "-skipr 1" // -r
params.skip_cols = "-skipc 2" // -s
params.mcl_version = "14-137" // -m
params.r_version = "4.4.0" // -v
params.python_version = "3.12.4"
params.get_anno_script_url="https://github.com/iansealy/bio-misc/raw/4e27d60323907d55d37a1ec8f468ca771f542f78/get_ensembl_gene_annotation.pl"
params.get_anno_bash_url="https://github.com/richysix/uge-job-scripts/raw/e5f5faad28b23ff55419726beef3675f9e5fdba3/get_ensembl_gene_annotation.sh"
params.get_go_anno_bash_url="https://github.com/richysix/uge-job-scripts/raw/e5f5faad28b23ff55419726beef3675f9e5fdba3/get-go-annotation.sh"

if (params.testing) {
    // params.expts = "${params.base_dir}/expt-sample-condition-test.tsv"
    // params.all_counts = "${params.base_dir}/everything/filter-strict/all-test.csv.gz"
    // params.transcript_file = "$params.ref_dir/Danio_rerio.GRCz11.98.transcripts.tsv"
    params.expts = "$HOME/checkouts/zmp-network/data/test-samples.tsv"
    params.all_counts = "$HOME/checkouts/zmp-network/data/test-counts.csv"
    params.transcript_file = "$HOME/checkouts/zmp-network/data/test-transcript-lengths.tsv"
    params.annotation_file = "$HOME/checkouts/zmp-network/data/test-annotation.txt"
    params.go_annotation_file = "$HOME/checkouts/zmp-network/data/test-go.txt"
    params.go_min_cluster_size = 1
    params.zfa_file = "$HOME/checkouts/zmp-network/data/test-zfa.txt"
    params.mem = ['1G', '1G']
    params.med_mem = ['1G', '1G']
    params.big_mem = ['1G', '2G']
    params.huge_mem = ['4G', '8G']
    params.min_term_size = 0
    params.max_term_size = 10
    params.threshold = [0.4, 0.5]
    params.knn = [3, 4]
    params.inflation_params = [1.4, 1.7]
    executor {
        name = "local"
    }
} else {
    params.expts = "$params.base_dir/expt-sample-condition-tfap2-plus.tsv"
    params.all_counts = "$params.base_dir/everything/filter-strict/all.csv.gz"
    params.transcript_file = "$params.ref_dir/Danio_rerio.GRCz11.98.transcripts.tsv"
    params.annotation_file="${params.ref_dir}/${params.species}-e${params.ensembl_version}-annotation.txt"
    params.go_annotation_file="${params.ref_dir}/${params.species}_e${params.ensembl_version}_go.txt"
    params.go_min_cluster_size = 50
    params.zfa_file = "$params.ref_dir/Dr-e98-Gene2ZFA.txt"
    params.mem = ['1G', '2G']
    params.med_mem = ['4G', '8G']
    params.big_mem = ['16G', '32G']
    params.huge_mem = ['80G', '128G']
    params.min_term_size = 10
    params.max_term_size = 1000
    params.threshold = [0.44, 0.6, 0.7, 0.8, 0.9]
    params.knn = [240, 200, 160, 120, 80]
    params.inflation_params = [1.4, 1.5, 1.6, 1.7]
    executor {
        name = "sge"
        retry.delay = "1000ms"
        submitRateLimit = "1sec"
    }
}

process {
    cpus = 1
    time = '1h'
    penv = 'smp'

    withLabel: local {
        executor = 'local'
    }

    withLabel: retry {
        clusterOptions = {
            if (task.attempt > 1) {
                return "-l h_vmem=${params.mem[1]}"
            } else {
                return "-l h_vmem=${params.mem[0]}"
            }
        }
        time = { 
            if (task.attempt > 1) {
                return '240h'
            } else {
                return '1h'
            }
        }
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'finish' }
        maxRetries = 1
    }

    withLabel: med_mem_retry {
        clusterOptions = {
            if (task.attempt > 1) {
                return "-l h_vmem=${params.med_mem[1]}"
            } else {
                return "-l h_vmem=${params.med_mem[0]}"
            }
        }
        time = { 
            if (task.attempt > 1) {
                return '240h'
            } else {
                return '1h'
            }
        }
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'finish' }
        maxRetries = 1
    }

    withLabel: big_mem_retry {
        clusterOptions = {
            if (task.attempt > 1) {
                return "-l h_vmem=${params.big_mem[1]}"
            } else {
                return "-l h_vmem=${params.big_mem[0]}"
            }
        }
        time = { 
            if (task.attempt > 1) {
                return '240h'
            } else {
                return '1h'
            }
        }
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'finish' }
        maxRetries = 1
    }

    withLabel: huge_mem_retry {
        clusterOptions = {
            if (task.attempt > 1) {
                return "-l h_vmem=${params.huge_mem[1]}"
            } else {
                return "-l h_vmem=${params.huge_mem[0]}"
            }
        }
        time = { 
            if (task.attempt > 1) {
                return '240h'
            } else {
                return '1h'
            }
        }
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'finish' }
        maxRetries = 1
    }
}
